<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>„Éà„É¨„Éº„É©„ÉºÈßêËªä„Ç≤„Éº„É†Ôºà„Éà„É¨„Éº„É©„ÉºÁ∏¶Èï∑ÈÄ£Áµê‰øÆÊ≠£Ôºâ</title>
  <style>
    body {
      margin: 0; background: #111; overflow: hidden; color: #eee; font-family: sans-serif;
      width: 414px;
      height: 896px;
      margin: 0 auto;
      position: relative;
    }
    canvas {
      display: block;
      background: #222;
      width: 414px;
      height: 896px;
      image-rendering: pixelated;
    }
    #controls {
      position: absolute;
      bottom: 10px;
      left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      user-select: none;
      width: 414px;
      margin: 0 auto;
    }
    .control-group {
      display: flex; flex-direction: column; gap: 10px;
    }
    button {
      width: 60px; height: 60px; font-size: 24px;
      background: #444; color: #fff; border: none; border-radius: 8px;
    }
    button:active {
      background: #0af;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 0 6px #0f0;
      width: 414px;
      text-align: center;
      pointer-events: none;
    }
    #timer {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      color: #afa;
      width: 414px;
      text-align: center;
      pointer-events: none;
    }
  </style>
</head>
<body>
<canvas id="game" width="414" height="896"></canvas>
<div id="status"></div>
<div id="timer"></div>

<div id="controls">
  <div class="control-group">
    <button id="forward">‚Üë</button>
    <button id="backward">‚Üì</button>
  </div>
  <div class="control-group">
    <button id="left">‚Üê</button>
    <button id="right">‚Üí</button>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const w = canvas.width;
const h = canvas.height;

const status = document.getElementById("status");
const timerEl = document.getElementById("timer");

const tractor = {
  x: w / 2,
  y: h - 120,
  angle: -Math.PI / 2,
  width: 30,
  height: 60,
  speed: 0,
  steer: 0,
  wheelBase: 40,
  steerAngle: 0,
  maxSteerAngle: Math.PI / 5
};

const trailer = {
  width: 40,
  length: 80,
  angle: -Math.PI / 2,
  x: 0,
  y: 0
};

// ÂàùÊúü‰ΩçÁΩÆ„Çª„ÉÉ„ÉàÔºà„Éà„É©„ÇØ„Çø„Éº„ÅÆÂæåÁ´ØÁ∏¶ÊñπÂêëÈÄ£ÁµêÔºâ
function resetTrailerPosition() {
  trailer.angle = tractor.angle;
  // „Éà„É©„ÇØ„Çø„ÉºÂæåÁ´Ø‰∏≠ÂøÉÂ∫ßÊ®ô
  const pinX = tractor.x - Math.cos(tractor.angle) * tractor.height / 2;
  const pinY = tractor.y - Math.sin(tractor.angle) * tractor.height / 2;
  // „Éà„É¨„Éº„É©„Éº‰∏≠ÂøÉ„ÅØ„Éî„É≥‰ΩçÁΩÆ„Åã„Çâ„Äå„Éà„É¨„Éº„É©„ÉºÈï∑„Åï„ÅÆÂçäÂàÜ„Äç„Å†„ÅëÂæå„Çç„Å´„Åö„Çâ„ÅôÔºàÁ∏¶ÊñπÂêëÔºâ
  trailer.x = pinX - Math.cos(trailer.angle) * trailer.length / 2;
  trailer.y = pinY - Math.sin(trailer.angle) * trailer.length / 2;
}

resetTrailerPosition();

const parking = {
  x: w - (tractor.wheelBase + trailer.length) / 2 - 30,
  y: h / 2,
  width: tractor.wheelBase + trailer.length,
  height: 40,
  angle: 0
};

let startTime = null;
let elapsedTime = 0;
let parked = false;

function updatePositions() {
  if (parked) return;

  tractor.steerAngle += tractor.steer * 0.04;
  tractor.steerAngle = Math.max(-tractor.maxSteerAngle, Math.min(tractor.maxSteerAngle, tractor.steerAngle));

  const beta = Math.tan(tractor.steerAngle) * (tractor.speed / tractor.wheelBase);
  tractor.angle += beta;
  tractor.x += Math.cos(tractor.angle) * tractor.speed;
  tractor.y += Math.sin(tractor.angle) * tractor.speed;

  // „Éà„É©„ÇØ„Çø„ÉºÂæåÁ´Ø‰∏≠ÂøÉÔºà„Éî„É≥Êé•Á∂öÁÇπÔºâ
  const pinX = tractor.x - Math.cos(tractor.angle) * tractor.height / 2;
  const pinY = tractor.y - Math.sin(tractor.angle) * tractor.height / 2;

  // „Éà„É¨„Éº„É©„ÉºËßíÂ∫¶„ÅØ„Éî„É≥‰ΩçÁΩÆ„Å®„ÅÆËßíÂ∫¶Â∑Æ„ÅßÊªë„Çâ„Åã„Å´ËøΩÂæì
  const dx = pinX - trailer.x;
  const dy = pinY - trailer.y;
  const desired = Math.atan2(dy, dx);

  let diff = desired - trailer.angle;
  while (diff > Math.PI) diff -= 2 * Math.PI;
  while (diff < -Math.PI) diff += 2 * Math.PI;
  trailer.angle += diff * 0.15;

  // ÈÄ£Áµê‰ΩçÁΩÆ„ÅØÁ∏¶ÊñπÂêë„Å´Ôºà„Éà„É¨„Éº„É©„ÉºÈï∑„ÅïÂçäÂàÜÂàÜÔºâÂæå„Çç„Å∏„Ç™„Éï„Çª„ÉÉ„Éà
  trailer.x = pinX - Math.cos(trailer.angle) * trailer.length / 2;
  trailer.y = pinY - Math.sin(trailer.angle) * trailer.length / 2;
}

function pointInRect(px, py, rx, ry, rw, rh, rAngle) {
  const cosA = Math.cos(-rAngle);
  const sinA = Math.sin(-rAngle);
  const dx = px - rx;
  const dy = py - ry;
  const localX = dx * cosA - dy * sinA;
  const localY = dx * sinA + dy * cosA;
  return localX >= -rw / 2 && localX <= rw / 2 && localY >= -rh / 2 && localY <= rh / 2;
}

function checkParking() {
  const angleDiffTractor = Math.abs(normalizeAngle(tractor.angle - parking.angle));
  const angleDiffTrailer = Math.abs(normalizeAngle(trailer.angle - parking.angle));
  const degLimit = 10 * Math.PI / 180;

  if (angleDiffTractor > degLimit || angleDiffTrailer > degLimit) return false;
  if (!pointInRect(tractor.x, tractor.y, parking.x, parking.y, parking.width, parking.height, parking.angle)) return false;
  if (!pointInRect(trailer.x, trailer.y, parking.x, parking.y, parking.width, parking.height, parking.angle)) return false;

  return true;
}

function normalizeAngle(angle) {
  while (angle > Math.PI) angle -= 2 * Math.PI;
  while (angle < -Math.PI) angle += 2 * Math.PI;
  return angle;
}

function drawVehicle() {
  ctx.clearRect(0, 0, w, h);

  // ÈßêËªäÊû†
  ctx.save();
  ctx.translate(parking.x, parking.y);
  ctx.rotate(parking.angle);
  ctx.strokeStyle = "#0f0";
  ctx.lineWidth = 2;
  ctx.strokeRect(-parking.width / 2, -parking.height / 2, parking.width, parking.height);
  ctx.restore();

  // „Éà„É¨„Éº„É©„ÉºÔºàÁ∏¶Èï∑Ôºâ
  ctx.save();
  ctx.translate(trailer.x, trailer.y);
  ctx.rotate(trailer.angle);
  ctx.fillStyle = "#aaa";
  ctx.fillRect(-trailer.width / 2, -trailer.length / 2, trailer.width, trailer.length);

  // „Éà„É¨„Éº„É©„Éº„Çø„Ç§„É§ÔºàÂ∑¶Âè≥ÔºíÊú¨„Åö„Å§„ÄÅÂâçÂæå„Å´Ôºâ
  ctx.fillStyle = "#000";
  const tw = 6, th = 12;
  const wHalf = trailer.width / 2;
  const lHalf = trailer.length / 2;

  // ÂâçËº™Ôºà‰∏äÁ´Ø‰∏°Á´ØÔºâ
  for (let dx of [-wHalf + 4, wHalf - 4]) {
    ctx.fillRect(dx - tw / 2, -lHalf + 4 - th / 2, tw, th);
  }
  // ÂæåËº™Ôºà‰∏ãÁ´Ø‰∏°Á´ØÔºâ
  for (let dx of [-wHalf + 4, wHalf - 4]) {
    ctx.fillRect(dx - tw / 2, lHalf - 4 - th / 2, tw, th);
  }

  ctx.restore();

  // „Éà„É©„ÇØ„Çø„ÉºÊú¨‰ΩìÔºàËµ§„ÅÑÁ∏¶Èï∑Ôºâ
  ctx.save();
  ctx.translate(tractor.x, tractor.y);
  ctx.rotate(tractor.angle);
  ctx.fillStyle = "red";
  ctx.fillRect(-tractor.width / 2, -tractor.height / 2, tractor.width, tractor.height);

  // „Çø„Ç§„É§
  ctx.fillStyle = "#000";
  const tw2 = 6, th2 = 12;
  const wHalf2 = tractor.width / 2;
  const hHalf2 = tractor.height / 2;

  // ÂâçËº™Ôºà‰∏äÁ´Ø‰∏°Á´ØÔºâ„Çπ„ÉÜ„Ç¢ËßíÂèçÊò†
  for (let dx of [-wHalf2 + 4, wHalf2 - 4]) {
    ctx.save();
    ctx.translate(dx, -hHalf2 + 4);
    ctx.rotate(tractor.steerAngle);
    ctx.fillRect(-tw2 / 2, -th2 / 2, tw2, th2);
    ctx.restore();
  }

  // ÂæåËº™Ôºà‰∏ãÁ´Ø‰∏°Á´ØÔºâÂõ∫ÂÆö
  for (let dx of [-wHalf2 + 4, wHalf2 - 4]) {
    ctx.fillRect(dx - tw2 / 2, hHalf2 - 4 - th2 / 2, tw2, th2);
  }

  ctx.restore();
}

function drawStatus() {
  if (parked) {
    status.textContent = "üöõ ÈßêËªäÊàêÂäüÔºÅ";
  } else {
    status.textContent = "";
  }
  timerEl.textContent = `Time: ${(elapsedTime / 1000).toFixed(2)} Áßí`;
}

function update(timestamp) {
  if (!startTime) startTime = timestamp;
  if (!parked) elapsedTime = timestamp - startTime;

  updatePositions();

  if (!parked && checkParking()) {
    parked = true;
  }

  drawVehicle();
  drawStatus();

  requestAnimationFrame(update);
}

// Êìç‰Ωú„Ç§„Éô„É≥„Éà
document.getElementById("forward").addEventListener("touchstart", () => tractor.speed = 2);
document.getElementById("forward").addEventListener("touchend", () => tractor.speed = 0);
document.getElementById("backward").addEventListener("touchstart", () => tractor.speed = -2);
document.getElementById("backward").addEventListener("touchend", () => tractor.speed = 0);
document.getElementById("left").addEventListener("touchstart", () => tractor.steer = -1);
document.getElementById("left").addEventListener("touchend", () => tractor.steer = 0);
document.getElementById("right").addEventListener("touchstart", () => tractor.steer = 1);
document.getElementById("right").addEventListener("touchend", () => tractor.steer = 0);

requestAnimationFrame(update);
</script>
</body>
</html>
